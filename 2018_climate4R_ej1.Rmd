---
title: "Full code for Example 1 of the paper `climate4R: An Ecosystem of R packages for Climate Data Access,\\ Post-processing and Bias Correction'"
author: "M. Iturbide, J. Bedia, S. Herrera, J. Baño, J. Fernández, M. D. Frías, R. Manzanas, D. San Martín, E. Cimadevilla, A.S. Cofiño, J. M. Gutiérrez"
date: "`r Sys.Date()`"
csl: elsarticle.csl
output: 
    rmarkdown::pdf_document:
        fig_caption: yes
        toc: yes
        pandoc_args: [
      "--number-sections",
      "--number-offset=0"
    ] 
vignette: >
  %\VignetteIndexEntry{mopa within the climate4R ecosystem}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set, results='hide', message=FALSE, echo=FALSE}
 knitr::opts_chunk$set(fig.width = 6, fig.height = 4, cache = TRUE, cache.path = "./cache/", fig.path = "./figs/") 
```

# Introduction

Packages in `climate4R`:
```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
options(java.parameters = "-Xmx8000m")
```

```{r, eval=FALSE}
library(devtools)
install_github(c("SantanderMetGroup/loadeR",
                 "SantanderMetGroup/loadeR.java",
                 "SantanderMetGroup/transformeR",
                 "SantanderMetGroup/visualizeR",
                 "SantanderMetGroup/downscaleR",
                 "SantanderMetGroup/climate4R.climdex")
```

```{r, message=FALSE, warning=FALSE}
library(loadeR)
library(transformeR)
library(visualizeR)
library(downscaleR)
library(climate4R.climdex)
```

# Example 1: Climate Indices from CORDEX Projections
## Loading, collocating and harmonizing data 

Define the study area.

```{r cars, message=FALSE, warning=FALSE}
lon <- c(-10, 20)
lat <- c(35, 46)
```

### Cliamte data loading from OpenDap server: E-OBS observational data 

Overview of the dataset with function `dataInventory`:

```{r, message=FALSE, warning=FALSE}
eobs<-"http://opendap.knmi.nl/knmi/thredds/dodsC/e-obs_0.25regular/tx_0.25deg_reg_v16.0.nc"
di <- dataInventory(eobs)
```

Loading with `loadGridData`:

```{r , message=FALSE, warning=FALSE, eval=FALSE}
SU <- loadGridData(eobs, var = "tx",
                    season = 1:12, 
                    years = 1971:2000,
                    lonLim = lon, 
                    latLim = lat,
                    aggr.m = "sum", 
                    condition = "GT", 
                    threshold = 25)
```

#### Using a dictionary

Standard variable naming:

```{r , message=FALSE, warning=FALSE}
## dictionary: standard names
C4R.vocabulary()
```

Create dic file (dictionary explained in the `loadeR` wiki: https://github.com/SantanderMetGroup/loadeR/wiki/Harmonization)

```{r , message=FALSE, warning=FALSE, eval=FALSE}
file.create("dicEOBS.dic")
writeLines(c("identifier,short_name,time_step,lower_time_bound,upper_time_bound,
             cell_method,offset,scale,deaccum,derived,interface",
             "tasmax,tx,24h,0,24,max,0,1,0,0,"), "dicEOBS.dic")
```

Repit loading operation but using the created dictionaty file:

```{r , message=FALSE, warning=FALSE}
SU <- loadGridData(eobs,
                         var = "tasmax",
                         season = 1:12,
                         lonLim = lon,
                         latLim = lat,
                         years = 1971:2000,
                         aggr.m = "sum", 
                         threshold = 25,
                         condition = "GT",
                         dictionary = "dicEOBS.dic")
```



#### Annual aggregation using `transformeR`

```{r , message=FALSE, warning=FALSE}
SU.annual <- aggregateGrid(SU, aggr.y = list(FUN = "sum"))
```

#### visualization using `visualizeR`

First we create color palettes
```{r, message=FALSE, warning=FALSE}
library(RColorBrewer)
colstx <- rev(brewer.pal(n = 9, "Spectral"))
colsindex <- rev(brewer.pal(n = 9, "RdYlBu"))
colsdelta <- brewer.pal(n = 9, "Reds")
colsbias <- brewer.pal(n = 9, "PiYG")
colssd <- brewer.pal(n = 9, "Blues")
```

```{r fig2a, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig2a}Southern Europe summer days for E-OBS and the historical period 1971-2000. Fig. 2a in the manuscript."}
spatialPlot(climatology(SU.annual), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```


### Cliamte data loading from local files: CORDEX climate change projections


```{r , eval = FALSE, message=FALSE, warning=FALSE}
#historical data
wdch <- "/myDirectoryOfHistoricalData/"
#climate change data
wdc <- "/myDirectoryOfClimateChangeData/"
list.files(wdc, recursive = T)
```

```{r , echo=FALSE, message=FALSE, warning=FALSE}
wdc <- "/oceano/gmeteo/DATA/ESGF/DATASETS/CORDEX/output/EUR-44/SMHI/ICHEC-EC-EARTH/rcp85/r12i1p1/RCA4/v1/day/tasmax/"
wdch <- "/oceano/gmeteo/DATA/ESGF/DATASETS/CORDEX/output/EUR-44/SMHI/ICHEC-EC-EARTH/historical/r12i1p1/RCA4/v1/day/tasmax/"

list.files(wdc, recursive = T)
```

Create catalogs:

```{r , message=FALSE, warning=FALSE}
makeAggregatedDataset(source.dir = wdc, recursive = T, ncml.file = "CDX_rcp85.ncml")
makeAggregatedDataset(source.dir = wdch, recursive = T, ncml.file = "CDX_hist.ncml")
```

Check temperature units:

```{r , message=FALSE, warning=FALSE}
di <- dataInventory("CDX_hist.ncml")
str(di$tasmax)
```

We see that the variable name is standard but not the units. This can be also controlled by a dictionary:

```{r, message=FALSE, warning=FALSE,eval=FALSE}
file.create("dicCDX.dic")
writeLines(c("identifier,short_name,time_step,lower_time_bound,upper_time_bound,
             cell_method,offset,scale,deaccum,derived,interface",
             "tasmax,tasmax,24h,0,24,max,-273.15,1,0,0,"), "dicCDX.dic")
```

```{r , message=FALSE, warning=FALSE}
SUh <- loadGridData(dataset = "CDX_hist.ncml",
                     var = "tasmax",
                     season = 1:12,
                     lonLim = lon,
                     latLim = lat,
                     years = 1971:2000,
                     aggr.m = "sum",
                     threshold = 25,
                     condition = "GT",
                     dictionary = "dicCDX.dic")
```



Annual aggragation and visualization of cordex historical data:

```{r , message=FALSE, warning=FALSE}
SUh.annual <- aggregateGrid(SUh, aggr.y = list(FUN = "sum"))
```

```{r fig2b, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig2b}Southern Europe summer days for CORDEX and the historical period 1971-2000. Fig. 2b in the manuscript."}
spatialPlot(climatology(SUh.annual), at = seq(0, 260, 10), 
            col.regions = colorRampPalette(colsindex))
```

### Bias eobs vs cordex. Illustrates interpGrid

```{r , message=FALSE, warning=FALSE}
SUh.interp <- interpGrid(SUh.annual, getGrid(SU.annual))

eobs.mask <- gridArithmetics(SU.annual, 0, operator = "*")
SUh.interp <- gridArithmetics(SUh.interp, eobs.mask, operator = "+")

bias <- gridArithmetics(SUh.interp, SU.annual, operator = "-")
```

```{r fig2c, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig2c}Southern Europe summer days for interpolated CORDEX and the historical period 1971-2000. Fig. 2c in the manuscript."}
spatialPlot(climatology(SUh.interp), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```
```{r fig2d, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig2d}Southern Europe summer days bias for CORDEX and the historical period 1971-2000. Fig. 2d in the manuscript."}
spatialPlot(climatology(bias), backdrop.theme = "countries", 
            at = seq(-100, 100, 10), col.regions = colorRampPalette(colsbias))
```

Loading data for the rcp8.5 scenario and period 2071-2100 using the same dictionary

```{r , message=FALSE, warning=FALSE}
# the same dictionary
SUf <- loadGridData(dataset = "CDX_rcp85.ncml",
                     var = "tasmax",
                     season = 1:12,
                     lonLim = lon,
                     latLim = lat,
                     years = 2071:2100,
                     aggr.m = "sum", 
                     threshold = 25,
                     condition = "GT",
                     dictionary = "dicCDX.dic")
```

```{r, message=FALSE, warning=FALSE}
SUf.annual <- aggregateGrid(SUf, aggr.y = list(FUN = "sum"))
```




### Calculate "Delta" signal

```{r, message=FALSE, warning=FALSE}
SUf.interp <- interpGrid(SUf.annual, getGrid(SU.annual))
SUf.interp <- gridArithmetics(SUf.interp, eobs.mask, operator = "+")

CCsignal <- gridArithmetics(SUf.interp, 
                            SUh.interp,
                            operator = "-")
```

```{r fig3a, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig3a}Southern Europe summer days for the interpolated EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100. Fig. 3a in the manuscript."}
spatialPlot(climatology(SUf.interp), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```
```{r fig3b, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig3b}Southern Europe summer days `delta' for the EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100. Fig. 3b in the manuscript."}
spatialPlot(climatology(CCsignal), backdrop.theme = "countries",
            at = seq(0, 80, 5), col.regions = colorRampPalette(colsdelta))
```

## Post-processing: Bias Correction

```{r, message=FALSE, warning=FALSE}
SUf.bc <- biasCorrection(y = SU, x = SUh, newdata = SUf, 
                         method = "scaling", scaling.type = "additive")
SUf.bc.annual <- aggregateGrid(SUf.bc, aggr.y = list(FUN = "sum"))

CCsignal.bc <- gridArithmetics(SUf.bc.annual, 
                            SU.annual,
                            operator = "-")
```


```{r fig3c, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig3c}Southern Europe summer days for the bias corrected (additive scaling) EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100. Fig. 3c in the manuscript."}
spatialPlot(climatology(SUf.bc.annual), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```
```{r fig3d, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig3d}Southern Europe summer days `delta' for the bias corrected (additive scaling) EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100. Not shown in the manuscript."}
spatialPlot(climatology(CCsignal.bc), backdrop.theme = "countries",
            at = seq(0, 80, 5), col.regions = colorRampPalette(colsdelta))
```


```{r fig4, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig4}Annual summer days time series for a single gridbox (Zaragoza, Spain) for the observations (E-OBS) and the projection (original and bias corrected) in the historical and future periods. Fig. 4 in the manuscript."}
Z <- lapply(list("E-OBS" = SU.annual, "CDX_hist" = SUh.interp, 
                 "CDX_rcp85" = SUf.interp, "CDX_rcp85_corrected" = SUf.bc.annual), 
            function(x)  subsetGrid(x, latLim = 41.64, lonLim = -0.89))
cols = c("black", "red", "red", "blue")
temporalPlot(Z, cols = cols, lwd = 0.8, xyplot.custom = list(ylab = "", ylim = c(70, 220),
  key = list(space = "top", lines = list(pch = 15, col = cols, cex = .5), 
             text = list(names(Z), 
                         cex = .7), columns = 2)))
```


```{r END_PART_1, echo=FALSE, message=FALSE, warning=FALSE}
rm(list = c("SU", "SU.annual", "SUh", "SUh.annual", "SUh.interp", "SUf", "SUf.interp", "SUf.annual", "SUf.bc", "SUf.bc.annual", "CCsignal", "CCsignal.bc", "bias"))
```

## Working with daily data



```{r, message=FALSE, warning=FALSE}
TX <- loadGridData(eobs,
                   var = "tasmax",
                     season = 1:12,
                         lonLim = lon,
                         latLim = lat,
                         years = 1971:2000,
                         dictionary = "dicEOBS.dic")
TXh <- loadGridData(dataset = "CDX_hist.ncml",
                     var = "tasmax",
                     season = 1:12,
                     lonLim = lon,
                     latLim = lat,
                     years = 1971:2000,
                     dictionary = "dicCDX.dic")
TXf <- loadGridData(dataset = "CDX_rcp85.ncml",
                     var = "tasmax",
                     season = 1:12,
                     lonLim = lon,
                     latLim = lat,
                     years = 2071:2100,
                     dictionary = "dicCDX.dic")
```

```{r, message=FALSE, warning=FALSE}
TXf.bc <- biasCorrection(y = TX, 
                         x = TXh, 
                         newdata = TXf, 
                         method = "eqm",
                         window = c(30, 7), 
                         extrapolation = "constant")
```

```{r, message=FALSE, warning=FALSE}
SUf <- climdexGrid(tx = TXf, index.code = "SU")
SUf.bc <- climdexGrid(tx = TXf.bc, index.code = "SU")
```

```{r , message=FALSE, warning=FALSE}
SUf.interp <- interpGrid(SUf, getGrid(TX))
SUf.interp <- gridArithmetics(SUf.interp, eobs.mask, operator = "+")
```


```{r fig5a, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig5a}Southern Europe summer days for the EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100 (calculated with package climate4R.climdex from daily data). Not shown in the manuscript."}
spatialPlot(climatology(SUf.interp), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```
```{r fig5, message=FALSE, warning=FALSE, fig.cap="\\label{fig:fig5}Southern Europe summer days for the bias corrected (emipirical quantile mapping) EC-EARTH driven, RCP8.5 scenario in the future period 2071-2100 (calculated with package climate4R.climdex from daily data). Fig. 5 in the manuscript."}
spatialPlot(climatology(SUf.bc), backdrop.theme = "countries", 
            at = seq(0, 260, 10), col.regions = colorRampPalette(colsindex))
```

```{r, echo= FALSE, message=FALSE, warning=FALSE}
rm(list = c("TX","TXh", "TXf", "TXf.bc", "SUf", "SUf.bc"))
```

